{
  "permissions": {
    "allow": [
      "Bash(npm run build:*)",
      "Bash(npm run migration:run:*)",
      "Bash(npm run typeorm:*)",
      "Bash(npm run migration:generate:*)",
      "Bash(npm run migration:generate:dev:*)",
      "Bash(npm run:*)",
      "Bash(rm:*)",
      "Bash(rmdir:*)",
      "Bash(netstat:*)",
      "Bash(findstr:*)",
      "Bash(taskkill /F /PID 22196)",
      "Bash(powershell -Command \"Stop-Process -Id 22196 -Force\")",
      "Bash(powershell -Command:*)",
      "Bash(curl:*)",
      "Bash(git apply:*)",
      "Bash(node fix-api.js:*)",
      "Bash(cat:*)",
      "Bash(node fix-frontend-geolocation.js:*)",
      "Bash(node fix-api-coordinates.js:*)",
      "Bash(node add-coordinates-validation.js:*)",
      "Bash(mkdir:*)",
      "Bash(git add:*)",
      "Bash(git reset:*)",
      "Bash(git commit:*)",
      "Bash(git push)",
      "Bash(npm install:*)",
      "Bash(\"C:/Users/Lucas Segovia/Desktop/petshops-api/src/modules/shops/entities/shop.entity.ts\" <<'EOF'\nimport {\n  Entity,\n  PrimaryGeneratedColumn,\n  Column,\n  CreateDateColumn,\n  UpdateDateColumn,\n  ManyToOne,\n  OneToMany,\n  OneToOne,\n  JoinColumn,\n} from 'typeorm';\nimport { User } from '../../users/entities/user.entity';\nimport { Product } from '../../products/entities/product.entity';\nimport { Subscription } from '../../subscriptions/entities/subscription.entity';\nimport { Review } from '../../reviews/entities/review.entity';\n\nexport enum ShopType {\n  RETAILER = 'retailer',\n  WHOLESALER = 'wholesaler',\n}\n\nexport enum ShopStatus {\n  PENDING_PAYMENT = 'pending_payment',\n  ACTIVE = 'active',\n  EXPIRED = 'expired',\n  SUSPENDED = 'suspended',\n}\n\n@Entity\\('shops'\\)\nexport class Shop {\n  @PrimaryGeneratedColumn\\('uuid'\\)\n  id: string;\n\n  @Column\\(\\)\n  name: string;\n\n  @Column\\({ type: 'text', nullable: true }\\)\n  description: string;\n\n  @Column\\(\\)\n  address: string;\n\n  @Column\\({ nullable: true }\\)\n  province: string;\n\n  @Column\\({ nullable: true }\\)\n  city: string;\n\n  @Column\\({ type: 'decimal', precision: 10, scale: 7 }\\)\n  latitude: number;\n\n  @Column\\({ type: 'decimal', precision: 10, scale: 7 }\\)\n  longitude: number;\n\n  @Column\\({\n    type: 'enum',\n    enum: ShopType,\n  }\\)\n  type: ShopType;\n\n  @Column\\({\n    type: 'enum',\n    enum: ShopStatus,\n    default: ShopStatus.PENDING_PAYMENT,\n  }\\)\n  status: ShopStatus;\n\n  @Column\\({ nullable: true }\\)\n  phone: string;\n\n  @Column\\({ nullable: true }\\)\n  email: string;\n\n  @Column\\({ nullable: true }\\)\n  website: string;\n\n  // Horarios de atenciÃ³n \\(JSON\\)\n  @Column\\({ type: 'jsonb', nullable: true }\\)\n  schedule: {\n    monday?: { open: string; close: string };\n    tuesday?: { open: string; close: string };\n    wednesday?: { open: string; close: string };\n    thursday?: { open: string; close: string };\n    friday?: { open: string; close: string };\n    saturday?: { open: string; close: string };\n    sunday?: { open: string; close: string };\n  };\n\n  @Column\\({ nullable: true }\\)\n  logo: string;\n\n  @Column\\({ nullable: true }\\)\n  banner: string;\n\n  // Banner promocional \\(solo para plan wholesaler - mÃ¡ximo 1 banner\\)\n  @Column\\({ type: 'jsonb', nullable: true }\\)\n  promotionalBanner: {\n    title: string;\n    subtitle: string;\n    imageUrl: string;\n    isActive: boolean;\n    createdAt: string;\n  };\n\n  @Column\\({ default: true }\\)\n  isActive: boolean;\n\n  // Contador de clicks/visitas al perfil de la tienda\n  @Column\\({ type: 'int', default: 0 }\\)\n  clickCount: number;\n\n  // Relaciones\n  @ManyToOne\\(\\(\\) => User, \\(user\\) => user.shops\\)\n  owner: User;\n\n  @OneToMany\\(\\(\\) => Product, \\(product\\) => product.shop\\)\n  products: Product[];\n\n  @OneToMany\\(\\(\\) => Review, \\(review\\) => review.shop\\)\n  reviews: Review[];\n\n  @CreateDateColumn\\(\\)\n  createdAt: Date;\n\n  @UpdateDateColumn\\(\\)\n  updatedAt: Date;\n}\nEOF)",
      "Bash(\"C:/Users/Lucas Segovia/Desktop/petshops-api/src/modules/analytics/analytics.service.ts\" <<'EOF'\n\n  /**\n   * Obtiene el ranking de tiendas \\(minoristas y mayoristas\\) por cantidad de clicks\n   */\n  async getShopsRankingByClicks\\(limit: number = 10\\) {\n    const { default: { Shop } } = await import\\('../shops/entities/shop.entity'\\);\n    const shopRepository = this.userRepository.manager.getRepository\\(Shop\\);\n    \n    const shops = await shopRepository\n      .createQueryBuilder\\('shop'\\)\n      .leftJoinAndSelect\\('shop.owner', 'owner'\\)\n      .select\\([\n        'shop.id',\n        'shop.name',\n        'shop.type',\n        'shop.clickCount',\n        'shop.province',\n        'shop.city',\n        'owner.id',\n        'owner.name',\n        'owner.email',\n      ]\\)\n      .where\\('shop.isActive = :isActive', { isActive: true }\\)\n      .orderBy\\('shop.clickCount', 'DESC'\\)\n      .limit\\(limit\\)\n      .getMany\\(\\);\n\n    return shops.map\\(shop => \\({\n      id: shop.id,\n      name: shop.name,\n      type: shop.type,\n      clickCount: shop.clickCount,\n      province: shop.province,\n      city: shop.city,\n      owner: {\n        id: shop.owner.id,\n        name: shop.owner.name,\n        email: shop.owner.email,\n      },\n    }\\)\\);\n  }\nEOF)",
      "Bash(\"C:/Users/Lucas Segovia/Desktop/petshops-api/src/modules/analytics/analytics.service.ts\" <<'ENDFILE'\nimport { Injectable, Logger } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository, Between, MoreThanOrEqual } from 'typeorm';\nimport { User, UserRole } from '../users/entities/user.entity';\nimport { Subscription, SubscriptionStatus } from '../subscriptions/entities/subscription.entity';\nimport { Shop } from '../shops/entities/shop.entity';\nimport { Cron, CronExpression } from '@nestjs/schedule';\n\n@Injectable\\(\\)\nexport class AnalyticsService {\n  private readonly logger = new Logger\\(AnalyticsService.name\\);\n  private newUsersToday: number = 0;\n\n  constructor\\(\n    @InjectRepository\\(User\\)\n    private userRepository: Repository<User>,\n    @InjectRepository\\(Subscription\\)\n    private subscriptionRepository: Repository<Subscription>,\n    @InjectRepository\\(Shop\\)\n    private shopRepository: Repository<Shop>,\n  \\) {\n    // Inicializar contador al inicio\n    this.updateNewUsersToday\\(\\);\n  }\n\n  /**\n   * Resetea el contador de usuarios nuevos del dÃ­a a medianoche\n   */\n  @Cron\\(CronExpression.EVERY_DAY_AT_MIDNIGHT, {\n    name: 'reset-new-users-counter',\n    timeZone: 'America/Argentina/Buenos_Aires',\n  }\\)\n  async resetNewUsersCounter\\(\\) {\n    this.logger.log\\('ðŸ”„ Reseteando contador de usuarios nuevos del dÃ­a'\\);\n    this.newUsersToday = 0;\n    await this.updateNewUsersToday\\(\\);\n    this.logger.log\\(`âœ… Contador reseteado. Nuevos usuarios hoy: ${this.newUsersToday}`\\);\n  }\n\n  /**\n   * Actualiza el contador de usuarios nuevos del dÃ­a\n   */\n  private async updateNewUsersToday\\(\\) {\n    const today = new Date\\(\\);\n    today.setHours\\(0, 0, 0, 0\\);\n\n    const tomorrow = new Date\\(today\\);\n    tomorrow.setDate\\(tomorrow.getDate\\(\\) + 1\\);\n\n    this.newUsersToday = await this.userRepository.count\\({\n      where: {\n        createdAt: Between\\(today, tomorrow\\),\n      },\n    }\\);\n  }\n\n  /**\n   * Obtiene las mÃ©tricas generales del dashboard\n   */\n  async getDashboardMetrics\\(\\) {\n    await this.updateNewUsersToday\\(\\);\n\n    // Total de usuarios\n    const totalUsers = await this.userRepository.count\\(\\);\n\n    // Usuarios por tipo\n    const clients = await this.userRepository.count\\({ where: { role: UserRole.CLIENT } }\\);\n    const retailers = await this.userRepository.count\\({ where: { role: UserRole.RETAILER } }\\);\n    const wholesalers = await this.userRepository.count\\({ where: { role: UserRole.WHOLESALER } }\\);\n\n    // Usuarios activos\n    const activeUsers = await this.userRepository.count\\({ where: { isActive: true } }\\);\n\n    // Nuevos usuarios en diferentes perÃ­odos\n    const now = new Date\\(\\);\n    const last7Days = new Date\\(now.getTime\\(\\) - 7 * 24 * 60 * 60 * 1000\\);\n    const last30Days = new Date\\(now.getTime\\(\\) - 30 * 24 * 60 * 60 * 1000\\);\n\n    const newUsers7Days = await this.userRepository.count\\({\n      where: {\n        createdAt: MoreThanOrEqual\\(last7Days\\),\n      },\n    }\\);\n\n    const newUsers30Days = await this.userRepository.count\\({\n      where: {\n        createdAt: MoreThanOrEqual\\(last30Days\\),\n      },\n    }\\);\n\n    // Suscripciones\n    const totalSubscriptions = await this.subscriptionRepository.count\\(\\);\n    const activeSubscriptions = await this.subscriptionRepository.count\\({\n      where: { status: SubscriptionStatus.ACTIVE },\n    }\\);\n    const pendingSubscriptions = await this.subscriptionRepository.count\\({\n      where: { status: SubscriptionStatus.PENDING },\n    }\\);\n    const cancelledSubscriptions = await this.subscriptionRepository.count\\({\n      where: { status: SubscriptionStatus.CANCELLED },\n    }\\);\n\n    // Usuarios con suscripciÃ³n activa\n    const usersWithActiveSubscription = await this.subscriptionRepository\n      .createQueryBuilder\\('subscription'\\)\n      .select\\('COUNT\\(DISTINCT subscription.userId\\)', 'count'\\)\n      .where\\('subscription.status = :status', { status: SubscriptionStatus.ACTIVE }\\)\n      .getRawOne\\(\\);\n\n    return {\n      users: {\n        total: totalUsers,\n        active: activeUsers,\n        inactive: totalUsers - activeUsers,\n        newToday: this.newUsersToday,\n        new7Days: newUsers7Days,\n        new30Days: newUsers30Days,\n        byRole: {\n          clients,\n          retailers,\n          wholesalers,\n        },\n      },\n      subscriptions: {\n        total: totalSubscriptions,\n        active: activeSubscriptions,\n        pending: pendingSubscriptions,\n        cancelled: cancelledSubscriptions,\n        usersWithActiveSubscription: parseInt\\(usersWithActiveSubscription?.count || '0'\\),\n      },\n    };\n  }\n\n  /**\n   * Obtiene estadÃ­sticas de usuarios por tipo y suscripciÃ³n\n   */\n  async getUserStats\\(\\) {\n    const usersByRole = await this.userRepository\n      .createQueryBuilder\\('user'\\)\n      .select\\('user.role', 'role'\\)\n      .addSelect\\('COUNT\\(*\\)', 'count'\\)\n      .groupBy\\('user.role'\\)\n      .getRawMany\\(\\);\n\n    const usersWithSubscription = await this.userRepository\n      .createQueryBuilder\\('user'\\)\n      .leftJoin\\('user.subscriptions', 'subscription'\\)\n      .select\\('user.role', 'role'\\)\n      .addSelect\\('subscription.plan', 'plan'\\)\n      .addSelect\\('subscription.status', 'status'\\)\n      .addSelect\\('COUNT\\(*\\)', 'count'\\)\n      .where\\('subscription.id IS NOT NULL'\\)\n      .groupBy\\('user.role'\\)\n      .addGroupBy\\('subscription.plan'\\)\n      .addGroupBy\\('subscription.status'\\)\n      .getRawMany\\(\\);\n\n    return {\n      usersByRole,\n      usersWithSubscription,\n    };\n  }\n\n  /**\n   * Obtiene tendencia de registros de usuarios en los Ãºltimos N dÃ­as\n   */\n  async getUserRegistrationTrend\\(days: number = 30\\) {\n    const startDate = new Date\\(\\);\n    startDate.setDate\\(startDate.getDate\\(\\) - days\\);\n    startDate.setHours\\(0, 0, 0, 0\\);\n\n    const users = await this.userRepository\n      .createQueryBuilder\\('user'\\)\n      .select\\(\"DATE\\(user.createdAt AT TIME ZONE 'America/Argentina/Buenos_Aires'\\)\", 'date'\\)\n      .addSelect\\('COUNT\\(*\\)', 'count'\\)\n      .where\\('user.createdAt >= :startDate', { startDate }\\)\n      .groupBy\\('date'\\)\n      .orderBy\\('date', 'ASC'\\)\n      .getRawMany\\(\\);\n\n    return {\n      period: `${days} days`,\n      data: users.map\\(u => \\({\n        date: u.date,\n        count: parseInt\\(u.count\\),\n      }\\)\\),\n    };\n  }\n\n  /**\n   * Obtiene tendencia de suscripciones en los Ãºltimos N dÃ­as\n   */\n  async getSubscriptionTrend\\(days: number = 30\\) {\n    const startDate = new Date\\(\\);\n    startDate.setDate\\(startDate.getDate\\(\\) - days\\);\n    startDate.setHours\\(0, 0, 0, 0\\);\n\n    const subscriptions = await this.subscriptionRepository\n      .createQueryBuilder\\('subscription'\\)\n      .select\\(\"DATE\\(subscription.createdAt AT TIME ZONE 'America/Argentina/Buenos_Aires'\\)\", 'date'\\)\n      .addSelect\\('subscription.status', 'status'\\)\n      .addSelect\\('COUNT\\(*\\)', 'count'\\)\n      .where\\('subscription.createdAt >= :startDate', { startDate }\\)\n      .groupBy\\('date'\\)\n      .addGroupBy\\('subscription.status'\\)\n      .orderBy\\('date', 'ASC'\\)\n      .getRawMany\\(\\);\n\n    return {\n      period: `${days} days`,\n      data: subscriptions.map\\(s => \\({\n        date: s.date,\n        status: s.status,\n        count: parseInt\\(s.count\\),\n      }\\)\\),\n    };\n  }\n\n  /**\n   * Obtiene estadÃ­sticas por provincia\n   */\n  async getUsersByProvince\\(\\) {\n    const users = await this.userRepository\n      .createQueryBuilder\\('user'\\)\n      .select\\('user.province', 'province'\\)\n      .addSelect\\('COUNT\\(*\\)', 'count'\\)\n      .where\\('user.province IS NOT NULL'\\)\n      .groupBy\\('user.province'\\)\n      .orderBy\\('count', 'DESC'\\)\n      .getRawMany\\(\\);\n\n    return users.map\\(u => \\({\n      province: u.province,\n      count: parseInt\\(u.count\\),\n    }\\)\\);\n  }\n\n  /**\n   * Obtiene el ranking de tiendas \\(minoristas y mayoristas\\) por cantidad de clicks\n   */\n  async getShopsRankingByClicks\\(limit: number = 10\\) {\n    const shops = await this.shopRepository\n      .createQueryBuilder\\('shop'\\)\n      .leftJoinAndSelect\\('shop.owner', 'owner'\\)\n      .where\\('shop.isActive = :isActive', { isActive: true }\\)\n      .orderBy\\('shop.clickCount', 'DESC'\\)\n      .limit\\(limit\\)\n      .getMany\\(\\);\n\n    return shops.map\\(shop => \\({\n      id: shop.id,\n      name: shop.name,\n      type: shop.type,\n      clickCount: shop.clickCount,\n      province: shop.province,\n      city: shop.city,\n      owner: {\n        id: shop.owner?.id,\n        name: shop.owner?.name,\n        email: shop.owner?.email,\n      },\n    }\\)\\);\n  }\n}\nENDFILE)",
      "Bash(git checkout:*)",
      "Bash(node update-analytics.js:*)",
      "Bash(node -p \"const fs = require\\(''fs''\\); const content = fs.readFileSync\\(''src/services/api.ts'', ''utf-8''\\); const lines = content.split\\(''\\\\n''\\); const interfaceIndex = lines.findIndex\\(l => l.includes\\(''// Helper para obtener el token''\\)\\); if \\(interfaceIndex > 0\\) { lines.splice\\(interfaceIndex, 0, ''export interface ShopRanking {'', ''  id: string;'', ''  name: string;'', ''  type: \\\\''retailer\\\\'' | \\\\''wholesaler\\\\'';'', ''  clickCount: number;'', ''  province?: string;'', ''  city?: string;'', ''  owner: {'', ''    id: string;'', ''    name: string;'', ''    email: string;'', ''  };'', ''}'', ''''\\); } fs.writeFileSync\\(''src/services/api.ts'', lines.join\\(''\\\\n''\\)\\); ''Interface added successfully''\")",
      "Bash(node:*)",
      "Bash(python -m json.tool:*)",
      "Bash(python:*)",
      "Bash(npx tsc:*)",
      "Bash(timeout 10 npx expo start:*)"
    ],
    "deny": [],
    "ask": []
  }
}
